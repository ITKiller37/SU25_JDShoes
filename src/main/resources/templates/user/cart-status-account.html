<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{user/layout-user.html}">
<head>
  <meta charset="UTF-8">
  <title>Trạng thái đơn hàng</title>
  <!-- Thêm CSS cho modal (nếu cần) -->
  <style>
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    .modal-content {
      background-color: #fff;
      margin: 15% auto;
      padding: 20px;
      width: 70%;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 5px;
      position: relative;
    }
    .close-modal {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 24px;
      cursor: pointer;
    }
    .product-detail-item {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
<div layout:fragment="content">
  <div id="loading-overlay">
    <div class="loading-spinner"></div>
  </div>

  <!-- breadcrumb -->
  <div class="container">
    <div class="bread-crumb flex-w p-l-25 p-r-15 p-t-30 p-lr-0-lg">
      <a href="/" class="stext-109 cl8 hov-cl1 trans-04">
        Home
        <i class="fa fa-angle-right m-l-9 m-r-10" aria-hidden="true"></i>
      </a>
      <span class="stext-109 cl4">
                Trạng thái đơn hàng
            </span>
    </div>
  </div>

  <!-- Shoping Cart -->
  <div class="bg0 p-t-75 p-b-85">
    <!-- Tab items -->
    <div class="container">
      <div class="tab-bills">
        <div class="tab-item" data-status="">
          Tất cả
        </div>
        <div class="tab-item" data-status="CHO_XAC_NHAN">
          Chờ xác nhận
        </div>
        <div class="tab-item" data-status="DA_XAC_NHAN">
          Đã xác nhận
        </div>
        <div class="tab-item" data-status="CHO_LAY_HANG">
          Chờ lấy hàng
        </div>
        <div class="tab-item" data-status="DANG_GIAO_HANG">
          Đang giao hàng
        </div>
        <div class="tab-item" data-status="GIAO_HANG_THANH_CONG">
          Giao hàng thành công
        </div>
        <div class="tab-item" data-status="GIAO_HANG_THAT_BAI">
          Giao hàng thất bại
        </div>
        <div class="tab-item" data-status="HOAN_THANH">
          Hoàn thành
        </div>
        <div class="tab-item" data-status="HUY">
          Đã hủy
        </div>
        <div class="tab-item" data-status="TRA_HANG">
          Đổi hàng
        </div>
        <div class="line"></div>
      </div>
      <div class="">
        <table class="table-shopping-cart">
          <tr class="table_head">
            <th class="text-center">Đơn hàng</th>
            <th class="text-center">Ngày đặt</th>
            <th class="text-center">Tổng tiền</th>
            <th class="text-center">Hình thức thanh toán</th>
            <th class="text-center">Trạng thái</th>
            <th class="text-center">Thông tin chi tiết</th>
            <th class="text-center">Hành động</th>
          </tr>
          <tr th:if="${bills.content.size() == 0}" class="text-center">
            <td colspan="7" class="font-italic">Không có đơn hàng nào</td>
          </tr>
          <tr class="product-item" th:each="bill : *{bills.content}">
            <td class="text-center" th:text="${bill.code}"></td>
            <td class="text-center" th:text="${#temporals.format(bill.createDate, 'dd/MM/yyyy HH:mm')}"></td>
            <td class="text-center" th:text="${#numbers.formatDecimal(bill.amount + bill.shippingFee, 0, 'POINT', 0, 'COMMA') + ' VND'}"></td>
            <td class="text-center" th:text="${bill.paymentMethod.name}"></td>
            <td class="text-center">
    <span th:switch="${bill.status}">
        <span th:case="${T(com.example.jdshoes.entity.enumClass.BillStatus).CHO_XAC_NHAN}">Chờ xác nhận</span>
        <span th:case="${T(com.example.jdshoes.entity.enumClass.BillStatus).DA_XAC_NHAN}">Đã xác nhận</span>
        <span th:case="${T(com.example.jdshoes.entity.enumClass.BillStatus).CHO_LAY_HANG}">Chờ lấy hàng</span>
        <span th:case="${T(com.example.jdshoes.entity.enumClass.BillStatus).DANG_GIAO_HANG}">Đang giao hàng</span>
        <span th:case="${T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THANH_CONG}">Giao hàng thành công</span>
        <span th:case="${T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THAT_BAI}">Giao hàng thất bại</span>
        <span th:case="${T(com.example.jdshoes.entity.enumClass.BillStatus).HOAN_THANH}">Hoàn thành</span>
        <span th:case="${T(com.example.jdshoes.entity.enumClass.BillStatus).HUY}">Đã hủy</span>
        <span th:case="${T(com.example.jdshoes.entity.enumClass.BillStatus).TRA_HANG}">Đổi hàng</span>
        <span th:case="*">Không xác định</span>
    </span>
            </td>
            <td class="">
              <span class="text-primary font-weight-bold js-show-modal cursor-pointer" th:attr="data-bill-id=${bill.id}">Hiển thị thông tin sản phẩm</span>
              <div class="modal" th:attr="id='modal-' + ${bill.id}">
                <div class="modal-content">
                  <span class="close-modal cursor-pointer">&times</span>
                  <h3>Thông tin đơn hàng: <span th:text="${bill.code}"></span></h3>
                  <div th:each="billDetail : ${bill.billDetail}">
                    <div class="product-detail-item">
                      <a th:href="'/product-detail/' + ${billDetail.productDetail.product.code}" th:text="${billDetail.productDetail.product.name}"></a>
                      <div>
                        <span class="mr-2" th:text="'Màu: ' + ${billDetail.productDetail.color.name}"></span>
                        <span class="mr-2" th:text="'Size: ' + ${billDetail.productDetail.size.name}"></span>
                        <span class="mr-2" th:text="'SL: ' + ${billDetail.quantity}"></span>
                        <span th:text="'Giá: ' + ${#numbers.formatDecimal(billDetail.detailPrice, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span>
                      </div>
                    </div>
                    <hr>
                  </div>
                  <p><strong>Tổng tiền:</strong> <span th:text="${#numbers.formatDecimal(bill.amount, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span></p>
                  <p><strong>Phí vận chuyển:</strong> <span th:text="${#numbers.formatDecimal(bill.shippingFee, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span></p>
                  <p><strong>Giảm giá:</strong> <span th:text="${#numbers.formatDecimal(bill.promotionPrice, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span></p>
                  <p><strong>Tổng thanh toán:</strong> <span th:text="${#numbers.formatDecimal(bill.amount.add(bill.shippingFee).subtract(bill.promotionPrice), 0, 'POINT', 0, 'COMMA')} + ' VND'"></span></p>
                  <p><strong>Địa chỉ giao hàng:</strong> <span th:text="${bill.customerAddress != null ? bill.customerAddress : 'Chưa cập nhật'}"></span></p>
                  <p><strong>Ghi chú:</strong> <span th:text="${bill.shippingNote != null ? bill.shippingNote : 'Không có'}"></span></p>
                </div>
              </div>
            </td>
            <td>
              <form method="POST" th:action="'/cancel-bill/' + ${bill.id}" class="form-cancel-order">
                <button type="submit" class="btn btn-danger" id="cancel-bill" th:if="${bill.status == T(com.example.jdshoes.entity.enumClass.BillStatus).CHO_XAC_NHAN or bill.status == T(com.example.jdshoes.entity.enumClass.BillStatus).DA_XAC_NHAN}">
                  Hủy đơn
                </button>
              </form>
            </td>
          </tr>
        </table>
        <nav th:if="${bills.totalPages > 0}" class="pagination is-right mt-4" role="navigation" aria-label="pagination">
          <ul class="pagination-list">
            <li>
              <a th:if="${bills.pageable.pageNumber != 0 && status == null}" th:href="@{/cart-status-account?page=0}" class="pagination-link" aria-label="First">
                <i class="fa fa-angle-double-left" aria-hidden="true"></i>
              </a>
              <a th:if="${bills.pageable.pageNumber != 0 && status != null}" th:href="@{'/cart-status-account?page=0' + '&status=' + ${status}}" class="pagination-link" aria-label="First">
                <i class="fa fa-angle-double-left" aria-hidden="true"></i>
              </a>
              <a th:unless="${bills.pageable.pageNumber != 0}" class="pagination-link is-disabled" aria-label="First">
                <i class="fa fa-angle-double-left" aria-hidden="true"></i>
              </a>
            </li>
            <li>
              <a th:if="${bills.pageable.pageNumber > 0 && status != null}" th:href="@{'/cart-status-account?page=' + ${bills.pageable.pageNumber - 1} + '&status=' + ${status}}" class="pagination-link" aria-label="Previous">
                <i class="fa fa-angle-left" aria-hidden="true"></i>
              </a>
              <a th:unless="${bills.pageable.pageNumber > 0}" class="pagination-link is-disabled" aria-label="Previous">
                <i class="fa fa-angle-left" aria-hidden="true"></i>
              </a>
            </li>
            <li th:each="page : ${#numbers.sequence(0, bills.totalPages - 1)}">
              <a th:if="${status == null}" th:href="@{'/cart-status-account?page=' + ${page}}" th:classappend="${page == bills.pageable.pageNumber} ? 'is-current'" class="pagination-link" aria-label="Page [[${page + 1}]]">
                [[${page + 1}]]
              </a>
              <a th:if="${status != null}" th:href="@{'/cart-status-account?page=' + ${page} + '&status=' + ${status}}" th:classappend="${page == bills.pageable.pageNumber} ? 'is-current'" class="pagination-link" aria-label="Page [[${page + 1}]]">
                [[${page + 1}]]
              </a>
            </li>
            <li>
              <a th:if="${bills.pageable.pageNumber < bills.totalPages - 1 && status == null}" th:href="@{'/cart-status-account?page=' + ${bills.pageable.pageNumber + 1}}" class="pagination-link" aria-label="Next">
                <i class="fa fa-angle-right" aria-hidden="true"></i>
              </a>
              <a th:if="${bills.pageable.pageNumber < bills.totalPages - 1 && status != null}" th:href="@{'/cart-status-account?page=' + ${bills.pageable.pageNumber + 1} + '&status=' + ${status}}" class="pagination-link" aria-label="Next">
                <i class="fa fa-angle-right" aria-hidden="true"></i>
              </a>
              <a th:unless="${bills.pageable.pageNumber < bills.totalPages - 1}" class="pagination-link is-disabled" aria-label="Next">
                <i class="fa fa-angle-right" aria-hidden="true"></i>
              </a>
            </li>
            <li>
              <a th:if="${bills.pageable.pageNumber < bills.totalPages - 1 && status == null}" th:href="@{'/cart-status-account?page=' + ${bills.totalPages - 1}}" class="pagination-link" aria-label="Last">
                <i class="fa fa-angle-double-right" aria-hidden="true"></i>
              </a>
              <a th:if="${bills.pageable.pageNumber < bills.totalPages - 1 && status != null}" th:href="@{'/cart-status?page=' + ${bills.totalPages - 1} + '&status=' + ${status}}" class="pagination-link" aria-label="Last">
                <i class="fa fa-angle-double-right" aria-hidden="true"></i>
              </a>
              <a th:unless="${bills.pageable.pageNumber < bills.totalPages - 1}" class="pagination-link is-disabled" aria-label="Last">
                <i class="fa fa-angle-double-right" aria-hidden="true"></i>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" th:inline="javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
  <script th:inline="javascript">
    $(document).ready(function () {
      // Hiển thị modal khi nhấp vào "Hiển thị thông tin sản phẩm"
      $('.js-show-modal').on('click', function () {
        const billId = $(this).data('bill-id');
        $('#modal-' + billId).css('display', 'block');
      });

      // Đóng modal khi nhấp vào nút đóng
      $('.close-modal').on('click', function () {
        $(this).closest('.modal').css('display', 'none');
      });

      // Đóng modal khi nhấp ra ngoài
      $('.modal').on('click', function (e) {
        if (e.target === this) {
          $(this).css('display', 'none');
        }
      });

      // Xử lý form hủy đơn
      $(".form-cancel-order").on('submit', function (e) {
        e.preventDefault();
        var form = this;

        Swal.fire({
          title: 'Hủy đơn hàng',
          text: 'Bạn chắc chắc muốn hủy đơn hàng này?',
          icon: 'warning',
          showCancelButton: true,
          cancelButtonText: 'Hủy',
          confirmButtonText: 'Xác nhận',
          reverseButtons: true
        }).then(async (result) => {
          if (result.isConfirmed) {
            form.submit();
          }
        });
      });

      var tabActivec = /*[[${status}]]*/ '';
      if (tabActivec == null) {
        tabActivec = '';
      }
      $(".tab-item").each(function (index) {
        const $tab = $(this);
        if ($tab.attr('data-status') == tabActivec) {
          $tab.addClass("active");
        }
      });

      openTab();

      function openTab() {
        const $tabs = $(".tab-item");
        const $line = $(".tab-bills .line");

        $line.css({
          left: $(".tab-item.active").position().left + "px",
          width: $(".tab-item.active").outerWidth() + "px"
        });

        $tabs.each(function () {
          const $tab = $(this);
          $tab.on("click", function () {
            $line.css({
              left: $tab.position().left + "px",
              width: $tab.outerWidth() + "px"
            });
            var status = $tab.attr('data-status');
            var url = status === '' ? '/cart-status-account' : `/cart-status-account?status=${status}`;
            window.location.href = url;
          });
        });
      }
    });
  </script>
</div>
</body>
</html>