<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/admin-layout.html}">

<head>
    <meta charset="UTF-8"/>
    <title>Chi tiết hóa đơn</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Đảm bảo phần nút không chồng lấn */
        .bill-detail-update-status {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            clear: both;
            position: relative;
        }

        /* Container cho các nút status */
        .status-actions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        /* Đảm bảo bảng có đủ khoảng cách */
        .table-responsive {
            margin-bottom: 50px;
            clear: both;
        }

        /* Responsive cho các nút */
        @media (max-width: 768px) {
            .status-actions-container {
                flex-direction: column;
            }

            .btn-update-status {
                width: 100%;
            }
        }

        /* Style cho nút lịch sử và thêm sản phẩm */
        .action-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
    </style>
</head>

<body>
<div layout:fragment="content">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="card" style="position: relative">
                    <div class="card-body">
                        <div class="invoice-title">
                            <div class="float-end mr-4">
                                <!-- Thanh tiến trình -->
                                <div class="track"
                                     th:if="${billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).TRA_HANG && billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).HUY}">
                                    <div class="step" th:classappend="${
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).CHO_XAC_NHAN ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).DA_XAC_NHAN ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).CHO_LAY_HANG ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).DANG_GIAO_HANG ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THANH_CONG ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).HOAN_THANH ? 'active' : ''}">
                                        <span class="icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                 viewBox="0 0 256 256">
                                                <path fill="currentColor"
                                                      d="M232 136.66A104.12 104.12 0 1 1 119.34 24a8 8 0 0 1 1.32 16A88.12 88.12 0 1 0 216 135.34a8 8 0 0 1 16 1.32ZM120 72v56a8 8 0 0 8h56a8 8 0 0 0 0-16h-48V72a8 8 0 0 0-16 0Zm40-24a12 12 0 1 0-12-12a12 12 0 0 0 12 12Zm36 24a12 12 0 1 0-12-12a12 12 0 0 0 12 12Zm24 36a12 12 0 1 0-12-12a12 12 0 0 0 12 12Z"/>
                                            </svg>
                                        </span>
                                        <span class="text">Chờ xác nhận</span>
                                    </div>
                                    <div class="step" th:classappend="${
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).DA_XAC_NHAN ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).CHO_LAY_HANG ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).DANG_GIAO_HANG ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THANH_CONG ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).HOAN_THANH ? 'active' : ''}">
                                        <span class="icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                 viewBox="0 0 24 24">
                                                <path fill="currentColor"
                                                      d="M18 10h-1.26A8 8 0 1 0 9 16h9a5 5 0 0 0 0-10Zm-8 6a6 6 0 1 1 6-6h2a3 3 0 1 1 0 6h-8Zm11-3a1 1 0 1 1-2 0a1 1 0 0 1 2 0Zm-3-1a1 1 0 1 1-2 0a1 1 0 0 1 2 0Zm-3-1a1 1 0 1 1-2 0a1 1 0 0 1 2 0Z"/>
                                            </svg>
                                        </span>
                                        <span class="text">Đã xác nhận</span>
                                    </div>
                                    <div class="step" th:classappend="${
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).CHO_LAY_HANG ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).DANG_GIAO_HANG ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THANH_CONG ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).HOAN_THANH ? 'active' : ''}">
                                        <span class="icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                 viewBox="0 0 24 24">
                                                <g fill="none" stroke-width="1.5">
                                                    <path fill="currentColor"
                                                          d="m2.695 7.185l9 4l.61-1.37l-9-4l-.61 1.37ZM12.75 21.5v-11h-1.5v11h1.5Zm-.445-10.315l9-4l-.61-1.37l-9 4l.61 1.37Z"/>
                                                    <path stroke="currentColor" stroke-linecap="round"
                                                          stroke-linejoin="round"
                                                          d="M3 17.11V6.89a.6.6 0 0 1 .356-.548l8.4-3.734a.6.6 0 0 1 .488 0l8.4 3.734A.6.6 0 0 1 21 6.89v10.22a.6.6 0 0 1-.356.548l-8.4 3.734a.6.6 0 0 1-.488 0l-8.4-3.734A.6.6 0 0 1 3 17.11Z"/>
                                                    <path stroke="currentColor" stroke-linecap="round"
                                                          stroke-linejoin="round"
                                                          d="m7.5 4.5l8.644 3.842a.6.6 0 0 1 .356.548v3.61"/>
                                                </g>
                                            </svg>
                                        </span>
                                        <span class="text">Chờ lấy hàng</span>
                                    </div>
                                    <div class="step" th:classappend="${
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).DANG_GIAO_HANG ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THANH_CONG ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).HOAN_THANH ? 'active' : ''}">
                                        <span class="icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                 viewBox="0 0 24 24">
                                                <path fill="currentColor"
                                                      d="M20 8h-3V6.22c0-1.39-1.06-2.53-2.45-2.66c-1.75-.16-3.29.96-3.65 2.62l-.03.13l-.37 2.9H4l-1 5v6h10v-2h8v2h2v-6l-1-5h-2Zm-7.5-1.72c0-.66.54-1.2 1.2-1.2s1.2.54 1.2 1.2v.07l-.12.93h-2.16l-.12-.93v-.07ZM4.96 12l.6-3h12.88l.6 3H4.96ZM12 18H6v-4h6v4Zm10 0h-8v-4h8v4Z"/>
                                            </svg>
                                        </span>
                                        <span class="text">Đang giao hàng</span>
                                    </div>
                                    <div class="step" th:classappend="${
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THANH_CONG ||
                                    billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).HOAN_THANH ? 'active' : ''}">
                                        <span class="icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                 viewBox="0 0 24 24">
                                                <path fill="currentColor"
                                                      d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2Zm-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9Z"/>
                                            </svg>
                                        </span>
                                        <span class="text">Giao hàng thành công</span>
                                    </div>
                                    <div class="step"
                                         th:classappend="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).HOAN_THANH ? 'active' : ''}">
                                        <span class="icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                 viewBox="0 0 24 24">
                                                <path fill="currentColor"
                                                      d="M19 13c.7 0 1.37.13 2 .35V12l-1-5H4l-1 5v2h1v6h9.09c-.05-.33-.09-.66-.09-1c0-1.23.37-2.36 1-3.31V14h1.69c.95-.63 2.08-1 3.31-1m-7 5H6v-4h6v4m-6.96-6l.6-3h12.72l.6 3H5.04M20 6H4V4h16v2m2.5 11.25L17.75 22L15 19l1.16-1.16l1.59 1.59l3.59-3.59l1.16 1.41"/>
                                            </svg>
                                        </span>
                                        <span class="text">Hoàn thành</span>
                                    </div>
                                </div>
                                <div th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).HUY}">
                                    <div class="text-danger font-weight-bold border rounded p-2 border-danger">
                                        ĐÃ HỦY
                                    </div>
                                </div>
                                <div th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).TRA_HANG}">
                                    <div class="text-danger font-weight-bold border rounded p-2 border-danger">
                                        ĐỔI HÀNG
                                    </div>
                                </div>
                                <div th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THAT_BAI}">
                                    <div class="status-failed"
                                         style="background-color: #fff; color: #dc3545; font-weight: bold; border: 1px solid #dc3545; border-radius: 5px; padding: 0.5rem 1rem; display: inline-block; margin-top: 5px; box-shadow: none;">
                                        GIAO HÀNG THẤT BẠI
                                    </div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <h2 class="mb-1 text-muted">
                                    Hóa đơn #[[${billdetail.maDinhDanh}]]
                                </h2>
                            </div>
                            <div class="text-muted">
                                <p class="mb-1">
                                    Giày thể thao nam JDShoes
                                </p>
                                <p class="mb-1">
                                    <i class="uil uil-envelope-alt me-1"></i>
                                    Jdshoes@gmail.com
                                </p>
                                <p><i class="uil uil-phone me-1"></i> 012-345-6789</p>
                            </div>
                        </div>

                        <hr class="my-4"/>

                        <div class="row">
                            <div class="col-sm-6">
                                <div class="text-muted">
                                    <h5 class="font-size-16 mb-3">Khách hàng:</h5>
                                    <h5 class="font-size-15 mb-2" th:if="${billdetail.maKhachHang != null}"
                                        th:text="${billdetail.tenKhachHang}">
                                        Preston Miller
                                    </h5>
                                    <h6 class="font-size-15 mb-2 font-italic"
                                        th:if="${billdetail.maKhachHang == null}">
                                        Khách lẻ
                                    </h6>
                                    <p th:if="${billdetail.maKhachHang != null}"
                                       th:text="${billdetail.soDienThoaiKhachHang}">
                                        001-234-5678
                                    </p>
                                    <!-- Chỉ hiển thị địa chỉ giao hàng nếu isShipping = true -->
                                    <div th:if="${bill.isShipping}">
                                        <h5 class="font-size-15 mb-3">Địa chỉ giao hàng:</h5>
                                        <h5 class="font-size-15 mb-2"
                                            th:text="${billdetail.tenKhachDatHang}">
                                            Preston Miller
                                        </h5>
                                        <p th:text="${billdetail.soDienThoaiNguoiNhan}">
                                            001-234-5678
                                        </p>
                                        <p class="mb-1" th:if="${billdetail.diaChiNguoiNhan != null}"
                                           th:text="${billdetail.diaChiNguoiNhan}">
                                            4068 Post Avenue Newfolden, MN 56738
                                        </p>
                                        <div th:if="${billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).DANG_GIAO_HANG &&
                                                      billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THANH_CONG &&
                                                      billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).HOAN_THANH &&
                                                      billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).HUY &&
                                                      billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).TRA_HANG &&
                                                      billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THAT_BAI}">
                                            <button type="button" class="btn btn-primary" data-toggle="modal"
                                                    data-target="#editAddressModal">
                                                Chỉnh sửa địa chỉ
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Modal chỉnh sửa địa chỉ -->
                                    <div class="modal fade" id="editAddressModal" tabindex="-1" role="dialog"
                                         aria-labelledby="editAddressModalLabel" aria-hidden="true"
                                         th:if="${bill.isShipping}">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="editAddressModalLabel">Chỉnh sửa địa chỉ
                                                        giao hàng</h5>
                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal"
                                                            aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <form th:action="@{'/admin/update-bill-address/' + ${billdetail.maDonHang}}"
                                                      method="post">
                                                    <div class="modal-body">
                                                        <div class="form-group">
                                                            <label for="customerName">Tên người nhận</label>
                                                            <input type="text" class="form-control" id="customerName"
                                                                   name="customerName"
                                                                   th:value="${billdetail.tenKhachDatHang}" required>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="customerPhoneNumber">Số điện thoại</label>
                                                            <input type="text" class="form-control"
                                                                   id="customerPhoneNumber" name="customerPhoneNumber"
                                                                   th:value="${billdetail.soDienThoaiNguoiNhan}"
                                                                   required>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="shipping-province">Tỉnh/Thành phố <span
                                                                    class="text-danger">*</span></label>
                                                            <select id="shipping-province" class="form-control"
                                                                    name="provinceId" required>
                                                                <option value="">Chọn tỉnh/thành</option>
                                                            </select>
                                                            <span class="error-text text-danger"
                                                                  style="display: none; font-size: 12px;">Vui lòng chọn tỉnh/thành</span>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="shipping-district">Quận/Huyện <span
                                                                    class="text-danger">*</span></label>
                                                            <select id="shipping-district" class="form-control"
                                                                    name="districtId" disabled required>
                                                                <option value="">Chọn quận/huyện</option>
                                                            </select>
                                                            <span class="error-text text-danger"
                                                                  style="display: none; font-size: 12px;">Vui lòng chọn quận/huyện</span>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="shipping-ward">Phường/Xã <span
                                                                    class="text-danger">*</span></label>
                                                            <select id="shipping-ward" class="form-control"
                                                                    name="wardCode" disabled required>
                                                                <option value="">Chọn phường/xã</option>
                                                            </select>
                                                            <span class="error-text text-danger"
                                                                  style="display: none; font-size: 12px;">Vui lòng chọn phường/xã</span>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="customerAddress">Địa chỉ cụ thể <span
                                                                    class="text-danger">*</span></label>
                                                            <input type="text" class="form-control" id="customerAddress"
                                                                   name="customerAddress"
                                                                   th:value="${billdetail.diaChiNguoiNhan?.split(', ')[0]}"
                                                                   required>
                                                            <span class="error-text text-danger"
                                                                  style="display: none; font-size: 12px;">Vui lòng nhập địa chỉ cụ thể</span>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="shipping-fee">Phí vận chuyển</label>
                                                            <input type="text" class="form-control"
                                                                   id="shipping-fee-display" readonly
                                                                   th:value="${billdetail.phiShip != null ? #numbers.formatDecimal(billdetail.phiShip, 0, 'POINT', 0, 'COMMA') + ' ₫' : '0 ₫'}">
                                                            <input type="hidden" id="shipping-fee" name="shippingFee"
                                                                   th:value="${billdetail.phiShip != null ? billdetail.phiShip : 0}">
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary"
                                                                data-dismiss="modal">Hủy
                                                        </button>
                                                        <button type="submit" class="btn btn-primary">Lưu</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="text-muted text-sm-end">
                                    <div class="mt-4">
                                        <h5 class="font-size-15 mb-1">Ngày mua hàng:</h5>
                                        <p
                                                th:text="${#temporals.format(billdetail.createdDate, 'dd-MM-yyyy HH:mm')}">
                                            25/11/2023
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="py-2 mb-4">
                            <div>
                                <h5>Voucher:</h5>
                            </div>
                            <div th:if="${billdetail.voucherName != null}">
                                <span style="color: red; font-size: 16px" th:text="${billdetail.voucherName}">
                                </span>
                            </div>
                            <div th:if="${billdetail.voucherName == null}">
                                <span class="text-muted">Không sử dụng</span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div>
                                Loại đơn :
                                <h5 style="color: rgb(21, 219, 153)">
                                    <span
                                            th:if="${billdetail.loaiHoaDon == T(com.example.jdshoes.entity.enumClass.InvoiceType).OFFLINE}">Tại
                                        quầy</span>
                                    <span
                                            th:if="${billdetail.loaiHoaDon == T(com.example.jdshoes.entity.enumClass.InvoiceType).ONLINE}">Online</span>
                                </h5>
                            </div>
                        </div>

                        <div class="mb-4">
                            <span>Mã giao dịch: <span class="text-warning font-weight-bold"
                                                      th:text="${billdetail.maGiaoDich}"></span></span>
                        </div>

                        <!-- Nút Thêm sản phẩm và Lịch sử hóa đơn -->
                        <div class="action-buttons">
                            <div th:if="${billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).DANG_GIAO_HANG &&
                                          billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THANH_CONG &&
                                          billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).HOAN_THANH &&
                                          billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).HUY &&
                                          billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).TRA_HANG &&
                                          billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THAT_BAI}">
                                <button type="button" class="btn btn-primary" data-toggle="modal"
                                        data-target="#addProductModal">
                                    Thêm sản phẩm
                                </button>
                            </div>
                            <button type="button" class="btn btn-info" data-toggle="modal"
                                    data-target="#historyModal">
                                Lịch sử hóa đơn
                            </button>
                        </div>

                        <!-- Modal lịch sử hóa đơn -->
                        <div class="modal fade" id="historyModal" tabindex="-1" role="dialog"
                             aria-labelledby="historyModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="historyModalLabel">Lịch sử hóa đơn</h5>
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal"
                                                aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="table-responsive">
                                            <table class="table align-middle table-nowrap table-centered mb-0">
                                                <thead>
                                                <tr>
                                                    <th>Trạng thái</th>
                                                    <th>Ghi chú</th>
                                                    <th>Người thực hiện</th>
                                                    <th>Ngày thực hiện</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <tr th:if="${billHistory == null}">
                                                    <td colspan="4" class="text-center text-danger">Không có dữ liệu lịch sử</td>
                                                </tr>
                                                <tr th:each="history : ${billHistory}">
                                                    <td th:text="${history.status}"></td>
                                                    <td th:text="${history.note}"></td>
                                                    <td th:text="${history.createdBy}"></td>
                                                    <td th:text="${#temporals.format(history.createdAt, 'dd-MM-yyyy HH:mm')}"></td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="py-2">
                            <h5 class="font-size-15">Danh sách đơn hàng</h5>
                            <div class="table-responsive">
                                <table class="table align-middle table-nowrap table-centered mb-0">
                                    <thead>
                                    <tr>
                                        <th>Sản phẩm</th>
                                        <th>Màu sắc</th>
                                        <th>Kích cỡ</th>
                                        <th>Giá tiền</th>
                                        <th>Số lượng</th>
                                        <th class="text-end" style="width: 120px">Thành tiền</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="productDetail : ${billDetailProduct}">
                                        <td>
                                            <div>
                                                <h6 class="text-truncate font-size-14 mb-1"
                                                    th:text="${productDetail.tenSanPham}">
                                                    Black Strap A012
                                                </h6>
                                            </div>
                                        </td>
                                        <td th:text="${productDetail.tenMau}"></td>
                                        <td th:text="${productDetail.kichCo}"></td>
                                        <td th:text="${#numbers.formatDecimal(productDetail.giaTien, 0, 'POINT', 0, 'COMMA')}"></td>
                                        <td th:text="${productDetail.soLuong}"></td>
                                        <td class="text-end"
                                            th:text="${#numbers.formatDecimal(productDetail.tongTien, 0, 'POINT', 0, 'COMMA')}">
                                            $ 245.50
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row" colspan="5" class="text-end">Tổng thanh toán sản phẩm</th>
                                        <td class="text-end"
                                            th:text="${#numbers.formatDecimal(total, 0, 'POINT', 0, 'COMMA')}">
                                    </tr>
                                    <tr>
                                        <th scope="row" colspan="5" class="text-end">Voucher:</th>
                                        <td class="border-0 text-end"
                                            th:text="${#numbers.formatDecimal(billdetail.tienKhuyenMai, 0, 'POINT', 0, 'COMMA')}">
                                    </tr>
                                    <tr>
                                        <th scope="row" colspan="5" class="text-end">Phí ship hiện tại:</th>
                                        <td class="border-0 text-end"
                                            th:text="${#numbers.formatDecimal((billdetail.phiShip != null ? billdetail.phiShip : 0), 0, 'POINT', 0, 'COMMA')}">
                                    </tr>
                                    <!-- Hiển thị số tiền đã thanh toán -->
                                    <!-- Trường hợp CHUYEN_KHOAN -->
                                    <tr th:if="${billdetail.phuongThucThanhToan == 'CHUYEN_KHOAN'}">
                                        <th scope="row" colspan="5" class="text-end">Số tiền đã thanh toán (sản phẩm ban đầu + phí ship cũ):</th>
                                        <td class="border-0 text-end">
                                            <span th:with="paidAmount = ${originalProductAmount + (oldShippingFee != null ? oldShippingFee : 0)}"
                                                  th:text="${#numbers.formatDecimal(paidAmount, 0, 'POINT', 0, 'COMMA')}"></span>
                                        </td>
                                    </tr>
                                    <!-- Trường hợp TIEN_MAT và OFFLINE -->
                                    <tr th:if="${billdetail.phuongThucThanhToan == 'TIEN_MAT' && billdetail.loaiHoaDon == T(com.example.jdshoes.entity.enumClass.InvoiceType).OFFLINE}">
                                        <th scope="row" colspan="5" class="text-end">Số tiền đã thanh toán:</th>
                                        <td class="border-0 text-end">
                                         <span th:with="paidAmount = ${originalProductAmount - billdetail.tienKhuyenMai + (oldShippingFee != null ? oldShippingFee : 0)}"
                                               th:text="${#numbers.formatDecimal(paidAmount, 0, 'POINT', 0, 'COMMA')}"></span>
                                        </td>
                                    </tr>
                                    <!-- Trường hợp TIEN_MAT và ONLINE (COD) -->
                                    <tr th:if="${billdetail.phuongThucThanhToan == 'TIEN_MAT' && billdetail.loaiHoaDon == T(com.example.jdshoes.entity.enumClass.InvoiceType).ONLINE}">
                                        <th scope="row" colspan="5" class="text-end">Số tiền đã thanh toán:</th>
                                        <td class="border-0 text-end">0</td>
                                    </tr>
                                    <!-- Hiển thị số tiền cần thanh toán thêm -->
                                    <!-- Trường hợp CHUYEN_KHOAN -->
                                    <tr th:if="${billdetail.phuongThucThanhToan == 'CHUYEN_KHOAN'}">
                                        <th scope="row" colspan="5" class="text-end">Số tiền cần thanh toán thêm (sản phẩm mới + chênh lệch phí ship):</th>
                                        <td class="border-0 text-end">
                                            <span th:with="
                                                newProductsAmount = ${total - originalProductAmount},
                                                shippingDiff = ${(billdetail.phiShip != null ? billdetail.phiShip : 0) - (oldShippingFee != null ? oldShippingFee : 0)},
                                                additionalAmount = ${(newProductsAmount < 0 ? 0 : newProductsAmount) + (shippingDiff < 0 ? 0 : shippingDiff)}"
                                                  th:text="${#numbers.formatDecimal(additionalAmount, 0, 'POINT', 0, 'COMMA')}"></span>
                                        </td>
                                    </tr>
                                    <!-- Trường hợp TIEN_MAT và OFFLINE -->
                                    <tr th:if="${billdetail.phuongThucThanhToan == 'TIEN_MAT' && billdetail.loaiHoaDon == T(com.example.jdshoes.entity.enumClass.InvoiceType).OFFLINE}">
                                        <th scope="row" colspan="5" class="text-end">Số tiền cần thanh toán thêm:</th>
                                        <td class="border-0 text-end">
                                            <span th:with="
                                                newProductsAmount = ${total - originalProductAmount},
                                                shippingDiff = ${(billdetail.phiShip != null ? billdetail.phiShip : 0) - (oldShippingFee != null ? oldShippingFee : 0)},
                                                additionalAmount = ${(newProductsAmount < 0 ? 0 : newProductsAmount) + (shippingDiff < 0 ? 0 : shippingDiff)}"
                                                  th:text="${#numbers.formatDecimal(additionalAmount, 0, 'POINT', 0, 'COMMA')}"></span>
                                        </td>
                                    </tr>
                                    <!-- Trường hợp TIEN_MAT và ONLINE (COD) -->
                                    <tr th:if="${billdetail.phuongThucThanhToan == 'TIEN_MAT' && billdetail.loaiHoaDon == T(com.example.jdshoes.entity.enumClass.InvoiceType).ONLINE}">
                                        <th scope="row" colspan="5" class="text-end">Số tiền cần thanh toán thêm:</th>
                                        <td class="border-0 text-end">
                                            <span th:with="additionalAmount = ${total - billdetail.tienKhuyenMai + (billdetail.phiShip != null ? billdetail.phiShip : 0)}"
                                                  th:text="${#numbers.formatDecimal(additionalAmount, 0, 'POINT', 0, 'COMMA')}"></span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th scope="row" colspan="5" class="border-0 text-end">Tổng thanh toán:</th>
                                        <td class="border-0 text-end">
                                            <h4 class="m-0 fw-semibold"
                                                th:text="${#numbers.formatDecimal(total - billdetail.tienKhuyenMai + (billdetail.phiShip != null ? billdetail.phiShip : 0), 0, 'POINT', 0, 'COMMA')}">
                                            </h4>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-print-none mt-4">
                                <div class="float-end">
                                    <a th:href="@{'/admin/export-pdf/'+${billdetail.maDonHang}}"
                                       class="btn btn-success me-1"><i class="fa fa-print"></i></a>
                                    <a th:href="@{'/admin/bill-list'}">
                                        <button type="button" class="btn btn-secondary w-md" data-dismiss="modal">
                                            Đóng
                                        </button>
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Modal thêm sản phẩm -->
                        <div class="modal fade" id="addProductModal" tabindex="-1" role="dialog"
                             aria-labelledby="addProductModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="addProductModalLabel">Thêm sản phẩm vào hóa
                                            đơn</h5>
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal"
                                                aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <form th:action="@{'/admin/add-product-to-bill/' + ${billdetail.maDonHang}}"
                                          method="post">
                                        <div class="modal-body">
                                            <div class="form-group">
                                                <label for="productDetailId">Sản phẩm</label>
                                                <select class="form-control" id="productDetailId"
                                                        name="productDetailId">
                                                    <option th:each="product : ${products}"
                                                            th:value="${product.id}"
                                                            th:text="${product.product.name + ' - ' + product.color.name + ' - ' + product.size.name + ' (Số lượng: ' + product.quantity + ' )'}">
                                                    </option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="quantity">Số lượng</label>
                                                <input type="number" class="form-control" id="quantity"
                                                       name="quantity" min="1" value="1">
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">
                                                Hủy
                                            </button>
                                            <button type="submit" class="btn btn-primary">Thêm</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Modal để nhập ghi chú -->
                        <div class="modal fade" id="noteModal" tabindex="-1" role="dialog"
                             aria-labelledby="noteModalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="noteModalLabel">Thêm ghi chú cho trạng thái</h5>
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal"
                                                aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <form id="noteForm"
                                          th:action="@{'/admin/update-bill-status2/' + ${billdetail.maDonHang}}"
                                          method="post">
                                        <div class="modal-body">
                                            <input type="hidden" name="trangThaiDonHang" id="statusInput">
                                            <div class="form-group">
                                                <label for="noteInput">Ghi chú</label>
                                                <textarea class="form-control" id="noteInput" name="note"
                                                          rows="4"></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                Hủy
                                            </button>
                                            <button type="submit" class="btn btn-primary">Xác nhận</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="py-2 bill-detail-update-status">
                            <div class="status-actions-container">
                                <form th:action="@{'/admin/update-bill-status2/' + ${billdetail.maDonHang}}"
                                      method="post">
                                    <input type="hidden" name="trangThaiDonHang" value="HUY"/>
                                    <button type="button" class="cancel-btn btn btn-danger rounded"
                                            th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).CHO_XAC_NHAN ||
                                               billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).DA_XAC_NHAN ||
                                               billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).CHO_LAY_HANG}">
                                        <i class="far fa-times-circle"></i> Hủy đơn này
                                    </button>
                                </form>

                                <div th:data-status="${billdetail.trangThaiDonHang}" class="btn-update-status mt-2"
                                     th:if="${billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).TRA_HANG &&
                                        billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).HUY &&
                                        billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).HOAN_THANH &&
                                        billdetail.trangThaiDonHang != T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THAT_BAI}">
                                    <form th:action="@{'/admin/update-bill-status2/' + ${billdetail.maDonHang}}"
                                          method="post">
                                        <input type="hidden" name="trangThaiDonHang" th:value="DA_XAC_NHAN"
                                               th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).CHO_XAC_NHAN}"/>
                                        <button type="button" class="btn btn-secondary text-wrap rounded status-btn"
                                                data-status="DA_XAC_NHAN"
                                                th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).CHO_XAC_NHAN}">
                                            <i class="far fa-check-square"></i> Xác nhận duyệt đơn hàng
                                        </button>
                                    </form>
                                    <form th:action="@{'/admin/update-bill-status2/' + ${billdetail.maDonHang}}"
                                          method="post">
                                        <input type="hidden" name="trangThaiDonHang" th:value="CHO_LAY_HANG"
                                               th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).DA_XAC_NHAN}"/>
                                        <button type="button" class="btn btn-primary text-wrap rounded status-btn"
                                                data-status="CHO_LAY_HANG"
                                                th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).DA_XAC_NHAN}">
                                            <i class="far fa-check-square"></i> Xác nhận chuẩn bị hàng
                                        </button>
                                    </form>
                                    <form th:action="@{'/admin/update-bill-status2/' + ${billdetail.maDonHang}}"
                                          method="post">
                                        <input type="hidden" name="trangThaiDonHang" th:value="DANG_GIAO_HANG"
                                               th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).CHO_LAY_HANG}"/>
                                        <button type="button" class="btn btn-info text-wrap rounded status-btn"
                                                data-status="DANG_GIAO_HANG"
                                                th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).CHO_LAY_HANG}">
                                            <i class="far fa-check-square"></i> Xác nhận chuyển cho shipper
                                        </button>
                                    </form>
                                    <form th:action="@{'/admin/update-bill-status2/' + ${billdetail.maDonHang}}"
                                          method="post">
                                        <input type="hidden" name="trangThaiDonHang" th:value="GIAO_HANG_THANH_CONG"
                                               th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).DANG_GIAO_HANG}"/>
                                        <button type="button" class="btn btn-warning text-wrap rounded status-btn"
                                                data-status="GIAO_HANG_THANH_CONG"
                                                th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).DANG_GIAO_HANG}">
                                            <i class="far fa-check-square"></i> Xác nhận giao hàng thành công
                                        </button>
                                    </form>
                                    <form th:action="@{'/admin/update-bill-status2/' + ${billdetail.maDonHang}}"
                                          method="post">
                                        <input type="hidden" name="trangThaiDonHang" th:value="GIAO_HANG_THAT_BAI"
                                               th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).DANG_GIAO_HANG}"/>
                                        <button type="button" class="btn btn-danger text-wrap rounded status-btn"
                                                data-status="GIAO_HANG_THAT_BAI"
                                                th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).DANG_GIAO_HANG}">
                                            <i class="far fa-times-circle"></i> Xác nhận giao hàng thất bại
                                        </button>
                                    </form>
                                    <form th:action="@{'/admin/update-bill-status2/' + ${billdetail.maDonHang}}"
                                          method="post">
                                        <input type="hidden" name="trangThaiDonHang" th:value="HOAN_THANH"
                                               th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THANH_CONG}"/>
                                        <button type="button" class="btn btn-success text-wrap rounded status-btn"
                                                data-status="HOAN_THANH"
                                                th:if="${billdetail.trangThaiDonHang == T(com.example.jdshoes.entity.enumClass.BillStatus).GIAO_HANG_THANH_CONG}">
                                            <i class="far fa-check-square"></i> Xác nhận hoàn thành
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            var $ = jQuery.noConflict();

            // Ánh xạ trạng thái với văn bản hiển thị trên thanh tiến trình
            const statusDisplayText = {
                'CHO_XAC_NHAN': 'Chờ xác nhận',
                'DA_XAC_NHAN': 'Đã xác nhận',
                'CHO_LAY_HANG': 'Chờ lấy hàng',
                'DANG_GIAO_HANG': 'Đang giao hàng',
                'GIAO_HANG_THANH_CONG': 'Giao hàng thành công',
                'HOAN_THANH': 'Hoàn thành',
                'GIAO_HANG_THAT_BAI': 'Giao hàng thất bại',
                'HUY': 'Đã hủy'
            };

            // Xử lý sự kiện click cho các nút chuyển trạng thái
            $('.status-btn').click(function () {
                var status = $(this).data('status');
                var statusText = statusDisplayText[status] || status;

                Swal.fire({
                    title: 'Xác nhận thay đổi trạng thái',
                    text: `Bạn có chắc muốn thay đổi trạng thái thành "${statusText}"?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Xác nhận',
                    cancelButtonText: 'Hủy',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        $('#statusInput').val(status);
                        $('#noteModal').modal('show');
                    }
                });
            });

            // Xử lý sự kiện click cho nút hủy đơn
            $('.cancel-btn').click(function () {
                var statusText = statusDisplayText['HUY'] || 'Đã hủy';

                Swal.fire({
                    title: 'Xác nhận hủy đơn hàng',
                    text: `Bạn có chắc muốn hủy đơn hàng này? Trạng thái sẽ được cập nhật thành "${statusText}".`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Xác nhận',
                    cancelButtonText: 'Hủy',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        $('#statusInput').val('HUY');
                        $('#noteModal').modal('show');
                    }
                });
            });

            // Đảm bảo modal đóng đúng cách
            $('#noteModal').on('hidden.bs.modal', function () {
                $(this).modal('hide');
                $('body').removeClass('modal-open');
                $('.modal-backdrop').remove();
            });

            // Đảm bảo modal địa chỉ đóng đúng cách
            $('#editAddressModal').on('hidden.bs.modal', function () {
                $(this).modal('hide');
                $('body').removeClass('modal-open');
                $('.modal-backdrop').remove();
            });

            // Đảm bảo modal thêm sản phẩm đóng đúng cách
            $('#addProductModal').on('hidden.bs.modal', function () {
                $(this).modal('hide');
                $('body').removeClass('modal-open');
                $('.modal-backdrop').remove();
            });

            // Đảm bảo modal lịch sử đóng đúng cách
            $('#historyModal').on('hidden.bs.modal', function () {
                $(this).modal('hide');
                $('body').removeClass('modal-open');
                $('.modal-backdrop').remove();
            });

            // Các biến global
            var provinces = [];
            var districts = [];
            var wards = [];
            var GHN_TOKEN = '6c4c54e4-5802-11f0-955f-6e01a39a71db';
            var SHOP_ID = 5871267;
            var FROM_DISTRICT = 1490;

            // Hàm load tỉnh/thành phố
            function loadProvinces(callback) {
                $.ajax({
                    url: 'https://online-gateway.ghn.vn/shiip/public-api/master-data/province',
                    method: 'GET',
                    headers: {
                        'Token': GHN_TOKEN,
                        'Content-Type': 'application/json'
                    },
                    success: function (response) {
                        if (response.code === 200) {
                            provinces = response.data;
                            $('#shipping-province').empty().append('<option value="">Chọn tỉnh/thành</option>');
                            $.each(provinces, function (index, province) {
                                $('#shipping-province').append(
                                    $('<option>', {
                                        value: province.ProvinceID,
                                        text: province.ProvinceName
                                    })
                                );
                            });
                            if (callback) callback();
                        } else {
                            console.error('Lỗi khi load tỉnh:', response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi AJAX khi load tỉnh:', error);
                        Swal.fire("Lỗi", "Không thể tải danh sách tỉnh/thành", "error");
                    }
                });
            }

            // Hàm load quận/huyện
            function loadDistricts(provinceId, callback) {
                if (!provinceId) return;

                $.ajax({
                    url: 'https://online-gateway.ghn.vn/shiip/public-api/master-data/district',
                    method: 'GET',
                    headers: {
                        'Token': GHN_TOKEN,
                        'Content-Type': 'application/json'
                    },
                    data: {
                        province_id: provinceId
                    },
                    success: function (response) {
                        if (response.code === 200) {
                            districts = response.data;
                            $('#shipping-district').empty().append('<option value="">Chọn quận/huyện</option>');
                            $.each(districts, function (index, district) {
                                $('#shipping-district').append(
                                    $('<option>', {
                                        value: district.DistrictID,
                                        text: district.DistrictName
                                    })
                                );
                            });
                            $('#shipping-district').prop('disabled', false);
                            if (callback) callback();
                        } else {
                            console.error('Lỗi khi load quận:', response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi AJAX khi load quận:', error);
                        Swal.fire("Lỗi", "Không thể tải danh sách quận/huyện", "error");
                    }
                });
            }

            // Hàm load phường/xã
            function loadWards(districtId, callback) {
                if (!districtId) return;

                $.ajax({
                    url: 'https://online-gateway.ghn.vn/shiip/public-api/master-data/ward',
                    method: 'GET',
                    headers: {
                        'Token': GHN_TOKEN,
                        'Content-Type': 'application/json'
                    },
                    data: {
                        district_id: districtId
                    },
                    success: function (response) {
                        if (response.code === 200) {
                            wards = response.data;
                            $('#shipping-ward').empty().append('<option value="">Chọn phường/xã</option>');
                            $.each(wards, function (index, ward) {
                                $('#shipping-ward').append(
                                    $('<option>', {
                                        value: ward.WardCode,
                                        text: ward.WardName
                                    })
                                );
                            });
                            $('#shipping-ward').prop('disabled', false);
                            if (callback) callback();
                        } else {
                            console.error('Lỗi khi load phường:', response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi AJAX khi load phường:', error);
                        Swal.fire("Lỗi", "Không thể tải danh sách phường/xã", "error");
                    }
                });
            }

            // Hàm tính phí vận chuyển
            function calculateShippingFee() {
                const districtId = $('#shipping-district').val();
                const wardCode = $('#shipping-ward').val();

                if (!districtId || !wardCode) {
                    $('#shipping-fee-display').val('0 ₫');
                    $('#shipping-fee').val('0');
                    return;
                }

                $('#shipping-fee-display').val('Đang tính...');

                // Lấy dịch vụ vận chuyển
                $.ajax({
                    url: 'https://online-gateway.ghn.vn/shiip/public-api/v2/shipping-order/available-services',
                    method: 'GET',
                    headers: {
                        'Token': GHN_TOKEN,
                        'Content-Type': 'application/json'
                    },
                    data: {
                        shop_id: SHOP_ID,
                        from_district: FROM_DISTRICT,
                        to_district: districtId
                    },
                    success: function (serviceResponse) {
                        if (serviceResponse.code === 200 && serviceResponse.data.length > 0) {
                            const serviceId = serviceResponse.data[0].service_id;

                            // Tính phí vận chuyển
                            $.ajax({
                                url: 'https://online-gateway.ghn.vn/shiip/public-api/v2/shipping-order/fee',
                                method: 'POST',
                                headers: {
                                    'Token': GHN_TOKEN,
                                    'Content-Type': 'application/json',
                                    'ShopId': SHOP_ID
                                },
                                data: JSON.stringify({
                                    "from_district_id": FROM_DISTRICT,
                                    "service_id": serviceId,
                                    "to_district_id": parseInt(districtId),
                                    "to_ward_code": wardCode,
                                    "weight": 200,
                                    "length": 10,
                                    "width": 10,
                                    "height": 10
                                }),
                                success: function (feeResponse) {
                                    if (feeResponse.code === 200) {
                                        const fee = feeResponse.data.total;
                                        $('#shipping-fee-display').val(new Intl.NumberFormat('vi-VN').format(fee) + ' ₫');
                                        $('#shipping-fee').val(fee);
                                    } else {
                                        $('#shipping-fee-display').val('0 ₫');
                                        $('#shipping-fee').val('0');
                                        console.error('Lỗi tính phí:', feeResponse.message);
                                    }
                                },
                                error: function (xhr, status, error) {
                                    $('#shipping-fee-display').val('0 ₫');
                                    $('#shipping-fee').val('0');
                                    console.error('Lỗi AJAX tính phí:', error);
                                }
                            });
                        } else {
                            $('#shipping-fee-display').val('0 ₫');
                            $('#shipping-fee').val('0');
                            console.error('Không có dịch vụ vận chuyển');
                        }
                    },
                    error: function (xhr, status, error) {
                        $('#shipping-fee-display').val('0 ₫');
                        $('#shipping-fee').val('0');
                        console.error('Lỗi AJAX lấy dịch vụ:', error);
                    }
                });
            }

            // Xử lý sự kiện khi modal hiển thị
            $('#editAddressModal').on('show.bs.modal', function () {
                loadProvinces(function () {
                    var currentAddress = /*[[${billdetail.diaChiNguoiNhan}]]*/ '';
                    if (currentAddress) {
                        try {
                            var addressParts = currentAddress.split(/,\s*/);
                            if (addressParts.length >= 4) {
                                var provinceName = addressParts.pop().trim();
                                var districtName = addressParts.pop().trim();
                                var wardName = addressParts.pop().trim();
                                var street = addressParts.join(', ').trim();

                                $('#customerAddress').val(street);

                                var province = provinces.find(function (p) {
                                    return p.ProvinceName.trim().toLowerCase() === provinceName.toLowerCase();
                                });

                                if (province) {
                                    $('#shipping-province').val(province.ProvinceID).trigger('change');

                                    setTimeout(function () {
                                        var district = districts.find(function (d) {
                                            return d.DistrictName.trim().toLowerCase() === districtName.toLowerCase();
                                        });

                                        if (district) {
                                            $('#shipping-district').val(district.DistrictID).trigger('change');

                                            setTimeout(function () {
                                                var ward = wards.find(function (w) {
                                                    return w.WardName.trim().toLowerCase() === wardName.toLowerCase();
                                                });

                                                if (ward) {
                                                    $('#shipping-ward').val(ward.WardCode);
                                                    var currentShippingFee = /*[[${billdetail.phiShip}]]*/ 0;
                                                    $('#shipping-fee').val(currentShippingFee || 0);
                                                    $('#shipping-fee-display').val(
                                                        currentShippingFee ? new Intl.NumberFormat('vi-VN').format(currentShippingFee) + ' ₫' : '0 ₫'
                                                    );
                                                    calculateShippingFee();
                                                }
                                            }, 500);
                                        }
                                    }, 500);
                                }
                            }
                        } catch (e) {
                            console.error('Lỗi parse địa chỉ:', e);
                        }
                    }
                });
            });

            // Xử lý sự kiện change
            $('#shipping-province').change(function () {
                var provinceId = $(this).val();
                $('#shipping-district').val('').prop('disabled', !provinceId);
                $('#shipping-ward').val('').prop('disabled', true);
                $('#shipping-fee').val('0 ₫');

                if (provinceId) {
                    loadDistricts(provinceId);
                }
            });

            $('#shipping-district').change(function () {
                var districtId = $(this).val();
                $('#shipping-ward').val('').prop('disabled', !districtId);
                $('#shipping-fee').val('0 ₫');

                if (districtId) {
                    loadWards(districtId);
                }
            });

            $('#shipping-ward, #customerAddress').change(function () {
                if ($('#shipping-ward').val() && $('#customerAddress').val()) {
                    calculateShippingFee();
                } else {
                    $('#shipping-fee-display').val('0 ₫');
                    $('#shipping-fee').val('0');
                }
            });

            // Validate form
            $('#editAddressModal form').submit(function (e) {
                var isValid = true;
                $('.error-text').hide();

                if (!$('#shipping-province').val()) {
                    $('#shipping-province').next('.error-text').show();
                    isValid = false;
                }

                if (!$('#shipping-district').val()) {
                    $('#shipping-district').next('.error-text').show();
                    isValid = false;
                }

                if (!$('#shipping-ward').val()) {
                    $('#shipping-ward').next('.error-text').show();
                    isValid = false;
                }

                if (!$('#customerAddress').val().trim()) {
                    $('#customerAddress').next('.error-text').show();
                    isValid = false;
                }

                if (!isValid) {
                    e.preventDefault();
                    Swal.fire("Lỗi", "Vui lòng điền đầy đủ thông tin địa chỉ", "error");
                }
            });
        });
    </script>
</div>
</body>
</html>