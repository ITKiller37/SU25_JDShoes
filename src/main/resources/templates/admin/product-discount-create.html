<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset="UTF-8">
  <title>Tạo giảm giá</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.1.1/flowbite.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.6.0/pagination.min.css" integrity="sha512-K1k7jSn9RDKEcn/ugqVVvWYu0bcS3q1w6m/5pQSnrj0bCfIqF6Wk49lkmckSb4wglvTP9V17LtS0q0XxYccXbg==" crossorigin="anonymous" referrerpolicy="no-referrer" />-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/simplePagination.js/1.4/jquery.simplePagination.min.js" integrity="sha512-J4OD+6Nca5l8HwpKlxiZZ5iF79e9sgRGSf0GxLsL1W55HHdg48AEiKCXqvQCNtA1NOMOVrw15DXnVuPpBm2mPg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplePagination.js/1.4/simplePagination.min.css" integrity="sha512-85KEMf8eFSgiFrs/gGSVg0S6JqrmCtvVcA+s1PTMl/qtqH0ucmhrYrAFXock7iSjCaVcCMUNgCEF+sdQBUp7pA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);

      z-index: 2;
      display: none;
    }
  </style>
</head>
<body>
<div id="overlay"></div>
<!-- Main modal -->
<div class="main-discount-create bg-gray-100 min-h-screen">
  <div class="px-4 py-4">
    <div class="main-section pt-8">
      <h5 class="mb-4 text-2xl font-extrabold leading-none tracking-tight text-gray-900 dark:text-white">Tạo giảm
        giá</h5>

      <nav class="flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
          <li class="inline-flex items-center">
            <a th:href="@{/admin}"
               class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
              <svg class="w-3 h-3 me-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                   fill="currentColor" viewBox="0 0 20 20">
                <path d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2a1 1 0 0 0 1.414 1.414L2 10.414V18a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-7.586l.293.293a1 1 0 0 0 1.414-1.414Z"/>
              </svg>
              Home
            </a>
          </li>
          <li>
            <div class="flex items-center">
              <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true"
                   xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                      stroke-width="2" d="m1 9 4-4-4-4"/>
              </svg>
              <a th:href="@{/admin-only/product-discount}"
                 class="ms-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ms-2 dark:text-gray-400 dark:hover:text-white">Đợt giảm
                giá</a>
            </div>
          </li>
          <li aria-current="page">
            <div class="flex items-center">
              <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true"
                   xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                      stroke-width="2" d="m1 9 4-4-4-4"/>
              </svg>
              <span class="ms-1 text-sm font-medium text-gray-500 md:ms-2 dark:text-gray-400">Tạo giảm giá</span>
            </div>
          </li>
        </ol>
      </nav>

      <div class="container mt-4">
        <div class="row">
          <div class="col-md-5">

            <!--Thêm khuyến maiiiii-->
            <div class="container mt-4">
              <div class="p-4 shadow rounded bg-white" style="max-width: 600px;">
                <form id="discountForm">
                  <div class="mb-3 form-group">
                    <label class="form-label">Tên đợt khuyến mãi</label>
                    <input type="text" class="form-control" name="name" placeholder="Nhập tên đợt khuyến mãi" required>
                  </div>
                  <div class="mb-3 form-group">
                    <label class="form-label">Giá trị</label>
                    <div class="input-group">
                      <input type="number" class="form-control" name="value" min="1" placeholder="Nhập giá trị" required>
                      <div class="input-group-text">
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="radio" name="type" value="%" checked>
                          <label class="form-check-label">%</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="radio" name="type" value="VND">
                          <label class="form-check-label">VNĐ</label>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="mb-3 form-group">
                    <label class="form-label" >Ngày bắt đầu</label>
                    <input type="datetime-local" class="form-control" name="startDate" required>
                  </div>

                  <div class="mb-3 form-group">
                    <label class="form-label">Ngày kết thúc</label>
                    <input type="datetime-local" class="form-control" name="endDate" required>
                  </div>

                  <div class="flex justify-end items-center mt-6 space-x-2 pb-6 rtl:space-x-reverse">
                    <button id="cancel-discount-btn" type="button" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600">Trở lại</button>
                    <button id="save-discount-btn" type="button" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Lưu</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <!--end-->
          <div class="col-md-7">
<!--        danh sách-->
            <form class="mt-4">
              <div class="flex">
                <label for="search-dropdown"
                       class="mb-2 text-sm font-medium text-gray-900 sr-only dark:text-white">Your Email</label>
                <button id="dropdown-button" data-dropdown-toggle="dropdown" class="flex-shrink-0 z- inline-flex items-center py-2.5 px-4 text-sm
                            font-medium text-center text-gray-900 bg-gray-100 border border-gray-300 rounded-s-lg hover:bg-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 dark:focus:ring-gray-700 dark:text-white dark:border-gray-600"
                        type="button">
                  <span>Tất cả các loại</span>
                  <svg class="w-2.5 h-2.5 ms-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"
                       fill="none" viewBox="0 0 10 6">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                          stroke-width="2" d="m1 1 4 4 4-4"/>
                  </svg>
                </button>
                <div id="dropdown"
                     class="z-10 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-44 dark:bg-gray-700">
                  <ul class="py-2 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdown-button">
                    <li>
                      <button type="button" data-category-id=""
                              class="category-item inline-flex w-full px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">
                        Tất cả các loại
                      </button>
                    </li>
                    <li th:each="category: ${categories}">
                      <button type="button" th:data-category-id="${category.id}"
                              class="category-item inline-flex w-full px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white"
                              th:text="${category.name}"></button>
                    </li>

                  </ul>
                </div>
                <div class="relative w-full">
                  <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                    <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true"
                         xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
                      <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"
                            stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
                    </svg>
                  </div>
                  <input type="search" id="search-dropdown" class="block p-2.5 ps-8 w-80 z-20 text-sm text-gray-900 bg-gray-50 rounded-e-lg border-s-gray-50 border-s-2 border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-s-gray-700
                                dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:border-blue-500"
                         placeholder="Tìm kiếm sản phẩm" required>
                </div>
              </div>
            </form>
            <div id="all-product" class="border border-gray-200">
              <div class="bg-zinc-50 border border-gray-200">
                <div class="flex justify-between">
                  <span class="font-bold py-2 px-2">Danh sách sản phẩm</span>
                  <span id="select-all" class="text-blue-500 py-2 px-2 cursor-pointer hover:text-blue-700">Chọn toàn bộ</span>
                </div>
              </div>
              <div class="bg-white list-product">
                <div class="product-item">
                  <div class="product-item-inner flex justify-between items-center mb-2 mx-4 py-2 border-b border-blue-200">
                    <div class="product-info flex items-center">
                      <div>
                        <div>
                          <span class="font-bold">Giày</span>
                        </div>
                        <div>
                                                <span class="text-gray-400">
                                                    <span>Barcode: </span>
                                                    <span class="mr-2">12332432535</span>

                                                </span>
                        </div>
                        <div>
                          <span class="text-gray-400">Giá bán: </span>
                          <span class="font-bold">1.000.000đ</span>
                        </div>
                      </div>
                    </div>
                    <div class="cursor-pointer hover:text-blue-500">
                      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"
                           viewBox="0 0 32 32">
                        <path fill="currentColor"
                              d="M16 3C8.832 3 3 8.832 3 16s5.832 13 13 13s13-5.832 13-13S23.168 3 16 3zm0 2c6.087 0 11 4.913 11 11s-4.913 11-11 11S5 22.087 5 16S9.913 5 16 5zm-1 5v5h-5v2h5v5h2v-5h5v-2h-5v-5h-2z"/>
                      </svg>
                    </div>
                  </div>
                </div>
              </div>
              <div id="pagination-container" class="flex justify-end"></div>
            </div>
          </div>
        </div>
      </div>



      <div class="main-area bg-white py-2 px-2 mt-4 h-screen">

        <div class="grid grid-cols-3 gap-2 mt-6">
          <div id="selected-product" class="border border-gray-200 col-span-2">
            <div class="bg-zinc-50 border border-gray-200">
              <div class="flex justify-between">
                <span class="font-bold py-2 px-2">Chi tiết sản phẩm</span>
              </div>
            </div>
            <div class="bg-white list-select-product">

            <div id="pagination-select-container" class="flex justify-end"></div>
          </div>
        </div>


      </div>
    </div>

  </div>
</div>



<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script type="module">

</script>
<script th:src="@{/admin/assets/js/validator.js}"></script>

<script th:inline="javascript">
  $(document).ready(function () {
    $('#submit-button').on('click', function () {
      const name = $('input[name="name"]').val().trim();

      if (!name) {
        Swal.fire('Lỗi', 'Vui lòng nhập tên đợt khuyến mãi', 'error');
        return;
      }

      const productDiscounts = selectedProducts.map(p => ({
        productDetailId: p.id,
        discountedAmount: p.discountedAmount,
        startDate: p.startDate,
        endDate: p.endDate
      }));

      if (productDiscounts.length === 0) {
        Swal.fire('Lỗi', 'Vui lòng chọn ít nhất một sản phẩm', 'error');
        return;
      }

      const dataSend = {
        name: name,
        productDiscounts: productDiscounts
      };

      $.ajax({
        type: 'POST',
        url: '/api/private/product-discount',
        contentType: 'application/json',
        data: JSON.stringify(dataSend),
        success: function () {
          Toastify({
            text: "Tạo đợt khuyến mãi thành công",
            className: "success",
            style: { background: "green" },
            duration: 2000
          }).showToast();

          setTimeout(() => window.location.href = '/admin-only/product-discount-list', 2100);
        },
        error: function (xhr) {
          Swal.fire('Lỗi', xhr.responseJSON?.message || 'Không thể tạo khuyến mãi', 'error');
        }
      });
    });
  });
  $(document).ready(function () {
    var productListInit= []
    var productListCurrent = []
    var productSelectedList = []
    var productSelectedListDetailId = []
    handleSubmit();

    $('#start-date-all').val(getCurrentDate())
    $('#end-date-all').val(getLastDayOfMonth())


    $('#open-modal-btn').on('click', function () {
      $('#overlay').show()
    })

    $('#close-modal-apply-all').on('click', function () {
      $('#overlay').hide()
    })

    $('#apply-all-form').on('submit', function () {
      if($("#start-date-all").val() >= $('#end-date-all').val()) {
        Swal.fire({text: 'Ngày bắt đầu phải nhỏ hơn ngày kết thúc', icon: 'error'})
      }
    })


    $(".category-item").on('click', function () {
      let categoryId = $(this).attr('data-category-id')
      $('#dropdown-button span').text($(this).text())
      $('#dropdown-button').attr('selected-id', categoryId)
      $('#dropdown').removeClass('block')
      $('#dropdown').addClass('hidden')
      getListProduct($('#search-dropdown').val(), categoryId)
    })

    function onlyAllowNumberInput(e) {
      const key = e.key;
      if (!/[\d\b]/.test(key)) {
        e.preventDefault();
      }
    }

    function removeAnyNonDigit(value) {
      return value.replace(/\D/g, '');
    }


    $.ajax({
      method: 'GET',
      type: 'json',
      url: `/api/products-no-pagination`,
      contentType: "application/json; charset=utf-8",
      success: function (data) {
        productListInit = data
        productListCurrent = productListInit
        loadHtmlProduct(productListInit)
        setInitChoosedFalse()
        paginateProductList(productListInit)
      },
      error: function (xhr, status, error) {
        Swal.fire({
          title: "Lỗi",
          text: xhr.responseJSON.message,
          icon: "error"
        });
      }
    })

    function setInitChoosedFalse() {
      productListInit.forEach(product => {
        product.productDetailDtos.forEach(detail => {
          detail.choosed = false
        })
      });
    }

    function paginateProductList(productList) {
      var items = $(".product-item");
      var numItems = items.length;
      var perPage = 4;

      items.slice(perPage).hide();

      $('#pagination-container').pagination({
        items: numItems,
        itemsOnPage: perPage,
        cssStyle: "light-theme",
        onPageClick: function (pageNumber) {
          var showFrom = perPage * (pageNumber - 1);
          var showTo = showFrom + perPage;
          items.hide().slice(showFrom, showTo).show();
        }
      });
    }


    function paginateSelectedProductList() {
      var items = $(".product-select-item");
      var numItems = items.length;
      var perPage = 5;

      items.slice(perPage).hide();

      $('#pagination-select-container').pagination({
        items: numItems,
        itemsOnPage: perPage,
        cssStyle: "light-theme",
        onPageClick: function (pageNumber) {
          var showFrom = perPage * (pageNumber - 1);
          var showTo = showFrom + perPage;
          items.hide().slice(showFrom, showTo).show();
        }
      });
    }

    $('#apply-all-btn').on('click', function () {
      const percent = $('#percentage-all').val()
      const startDate = $("#start-date-all").val()
      const endDate = $('#end-date-all').val()

      $('.percentage').val(percent).trigger('input')
      $('.startDate').val(startDate)
      $('.endDate').val(endDate)
      $('#overlay').hide()
    })

    $('#percentage-all').on('input', function () {
      if($(this).val() > 98) {
        $(this).val(98);
        Toastify({
          text: "Không thể nhập quá 98%",
          className: "error",
          style: {
            background: "red",
          }
        }).showToast();
        return
      }
    })


    // Handle search product
    var debounceTimer;
    $("#search-dropdown").on('input', function () {
      var searchKey = $(this).val().trim()
      const categoryId = $('#dropdown-button').attr('selected-id')
      if(categoryId) {
        getListProduct(searchKey, categoryId)
      }else  {
        getListProduct(searchKey, null)

      }
    })


    function getListProduct(keyword, categoryId) {
      if (debounceTimer) {
        clearTimeout(debounceTimer);
      }

      var url = `/api/products-no-pagination`
      if(keyword != null && keyword.trim() != "") {
        url += `?keyword=${keyword}`
      }
      if(categoryId != null && categoryId.trim() != "") {
        if(url.includes("?")) {
          url += `&categoryId=${categoryId}`
        }
        else {
          url += `?categoryId=${categoryId}`
        }
      }

      debounceTimer = setTimeout(async function () {
        await $.ajax({
          method: 'GET',
          type: 'json',
          url: url,
          contentType: "application/json; charset=utf-8",
          success: function (data) {
            productListCurrent = data
            setChoosed(productListCurrent)
            loadHtmlProduct(productListCurrent)
            paginateProductList(productListCurrent)
          },
          error: function (xhr, status, error) {
            Swal.fire({
              title: "Lỗi",
              text: "xhr.responseJSON.message",
              icon: "error"
            });
          }
        })
      }, 500)
    }

    function setChoosed(productListCurrent) {
      productListCurrent.forEach(product => {
        product.productDetailDtos.forEach(detail => {
          if(productSelectedListDetailId.find(item => item == detail.id)) {
            detail.choosed = true
          }
        })
      })
    }

    function loadHtmlProduct(productList) {
      var html = ''
      productList.forEach(product => {
        product.productDetailDtos.forEach(detail => {
          // Check if detail.choosed is true
          const isChoosedClass = detail.choosed ? 'is-choosed' : '';
          var htmlPrice = ``
          if(detail.discountedPrice == null) {
            htmlPrice = `<span class="font-bold text-sm">${detail.price}</span>`
          }
          else {
            htmlPrice = `
                        <span class="text-sm line-through italic mr-1">${detail.price}</span>
                        <span class="font-bold text-sm">${detail.discountedPrice}</span>
                        `
          }
          html += `<div class="product-item group ${isChoosedClass} [&.is-choosed]:bg-gray-400/25" data-detail-id="${detail.id}">
                                   <div class="product-item-inner flex justify-between items-center mb-4 mx-4 py-2 border-b border-blue-200">
                                       <div class="product-info flex items-center">
                                           <div class="w-12 h-16 mr-4">
                                               <img src="/${product.imageUrl}" alt="">
                                           </div>
                                           <div>
                                               <div>
                                                   <span class="font-bold text-sm">${product.name}</span>
                                               </div>
                                               <div>
                                                <span class="product-detail text-gray-400">
                                                    <span class="text-sm">Barcode: </span>
                                                    <span class="mr-2 text-sm">${detail.barcode}</span>
                                                    <span class="text-sm">Size: </span>
                                                    <span class="mr-2 text-sm">${detail.size.name}</span>
                                                    <span>Màu: </span>
                                                    <span class="text-sm">${detail.color.name}</span>
                                                </span>
                                               </div>
                                               <div>
                                                   <span class="text-gray-400 text-sm">Giá bán: </span>
                                                   ${htmlPrice}
                                                   <span class="ml-4 hidden group-[.is-choosed]:inline text-sm font-bold">Đã chọn</span>
                                               </div>
                                           </div>
                                       </div>
                                       <button class="choose-product-btn cursor-pointer hover:text-blue-500 group-[.is-choosed]:text-gray-400" >
                                           <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><path fill="currentColor" d="M16 3C8.832 3 3 8.832 3 16s5.832 13 13 13s13-5.832 13-13S23.168 3 16 3zm0 2c6.087 0 11 4.913 11 11s-4.913 11-11 11S5 22.087 5 16S9.913 5 16 5zm-1 5v5h-5v2h5v5h2v-5h5v-2h-5v-5h-2z"/></svg>
                                       </button>
                                   </div>
                                </div>`
        })
      })
      $('.list-product').html(html)
      chooseProduct()

    }

    function chooseProduct() {
      $('.choose-product-btn').on('click', function () {
        const productItemEl = $(this).closest('.product-item')
        $(this).prop('disabled', true)
        const productDetailId = productItemEl.attr('data-detail-id')
        productSelectedListDetailId.push(productDetailId)
        productItemEl.addClass('is-choosed')

        let isFound = false;
        productListInit.forEach(product => {
          product.productDetailDtos.forEach(detail => {
            if(detail.id == productDetailId) {
              detail.choosed = true
              productSelectedList.push({
                name: product.name,
                imageUrl: product.imageUrl,
                detail: detail
              })
              appendSelectProduct({
                name: product.name,
                imageUrl: product.imageUrl,
                detail: detail
              })
              paginateSelectedProductList()
              isFound = true;
              return
            }
          })
          if(isFound) {
            return
          }
        })
      })
    }

    function appendSelectProduct(product) {
      var html = `<div class="product-select-item" data-select-detail-id="${product.detail.id}">
                                <div class="product-select-item-inner flex justify-between items-center mx-4 py-4 border-b border-blue-200">
                                    <div class="product-select-info flex items-center">
                                        <div class="w-12 h-16 mr-4">
                                            <img src="/${product.imageUrl}"
                                                 alt="">
                                        </div>
                                        <div>
                                            <div>
                                                <span class="font-bold text-sm">${product.name}</span>
                                            </div>
                                            <div>
                                                <span class="text-gray-400 text-sm">
                                                    <span>Barcode: </span>
                                                     <span class="mr-2">${product.detail.barcode}</span>
                                                    <span>Size: </span>
                                                    <span class="mr-2">${product.detail.size.name}</span>

                                                    </span>
                                            </div>
                                            <div>
                                                <span class="text-gray-400 text-sm">Giá bán: </span>
                                                <span class="product-select-price font-bold text-sm">${product.detail.price}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`

      $('.list-select-product').append(html)
      handleRemoveSelect()
    }

    function getCurrentDate() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function getLastDayOfMonth() {
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth() + 1;
      const lastDayOfMonth = new Date(year, month, 0).getDate();
      const lastDayFormatted = `${year}-${month.toString().padStart(2, '0')}-${lastDayOfMonth.toString().padStart(2, '0')}`;
      return lastDayFormatted;
    }

    function handleRemoveSelect() {
      $('.remove-select-btn').on('click', function () {
        const $productSelectItem = $(this).closest('.product-select-item')
        const detailId = $productSelectItem.attr('data-select-detail-id')
        productSelectedListDetailId = productSelectedListDetailId.filter(item => item != detailId)
        $(`.product-item[data-detail-id='${detailId}']`).removeClass('is-choosed')
        $(`.product-item[data-detail-id='${detailId}']`).find('button').prop('disabled', false)
        $productSelectItem.remove()
        paginateSelectedProductList()
      })
    }


    //     ============================================ HANDLE SUBMIT ==========================
    function handleSubmit() {
      $('#save-discount-btn').on('click', async function () {
        const discountName = $('input[name="name"]').val().trim();
        if (!discountName) {
          Swal.fire('Lỗi', 'Vui lòng nhập tên đợt khuyến mãi', 'error');
          return;
        }
        var productDiscounts = []
        var canSubmit = true
        // Lấy giá trị từ form chính (áp dụng cho tất cả sản phẩm)
        const value = $('input[name="value"]').val()
        const type = $('input[name="type"]:checked').val()
        const startDateRaw = $('input[name="startDate"]').val()
        const endDateRaw = $('input[name="endDate"]').val()

        const startDate = startDateRaw + ':00'  // ➕ thêm phần giây
        const endDate = endDateRaw + ':00'

// Validate chung
        if (!value || value.trim() === '') {
          Swal.fire({
            title: 'Lỗi',
            text: 'Vui lòng điền đầy đủ giá trị giảm',
            icon: 'error',
          })
          return
        }

        if (!startDate || startDate.trim() === '') {
          Swal.fire({
            title: 'Lỗi',
            text: 'Vui lòng điền đầy đủ ngày bắt đầu',
            icon: 'error',
          })
          return
        }

        if (!endDate || endDate.trim() === '') {
          Swal.fire({
            title: 'Lỗi',
            text: 'Vui lòng điền đầy đủ ngày kết thúc',
            icon: 'error',
          })
          return
        }

// Validate logic ngày
        if (startDate >= endDate) {
          Swal.fire({
            title: 'Lỗi',
            text: 'Ngày bắt đầu phải nhỏ hơn ngày kết thúc',
            icon: 'error',
          })
          return
        }

// Build danh sách productDiscounts
        await $('.product-select-item').each((index, item) => {
          const productItem = $(item)

          productDiscounts.push({
            discountedAmount: value,
            discountType: type,
            startDate: startDate ,
            endDate: endDate,
            productDetailId: productItem.attr('data-select-detail-id')
          })
        })


        if(!canSubmit) {
          return;
        }

        const dataSend = {name: discountName,productDiscounts: productDiscounts}
        await $.ajax({
          type: "POST",
          url: `/api/private/product-discount/multiple`,
          dataType: 'json',
          contentType: "application/json; charset=utf-8",
          data: JSON.stringify(dataSend),
          success: function () {
            Swal.fire({
              title: 'Tạo giảm giá',
              text: 'Thiết lập giảm giá thành công',
              icon: 'success',
              showCancelButton: true,
              confirmButtonText: 'Tiếp tục thiết lập',
              cancelButtonText: 'Quay lại'
            }).then((result) => {
              if (result.isConfirmed) {
                // Chuyển trang khi người dùng nhấn "OK"
                window.location.reload()
              } else {
                window.location.href = '/admin-only/product-discount'
              }
            });
          },
          error: function (xhr, status, error) {
            console.error(xhr.responseText);
            Swal.fire("Error", "Có lỗi xảy ra", "error");
          }
        })

      })
    }





    $('#cancel-discount-btn').on('click', function () {
      window.location.href = '/admin-only/product-discount'
    })

    $('#select-all').on('click', function () {
      $('.product-item').addClass('is-choosed')
      $('.product-item').prop('disabled', true)
      $('.product-item').each((index, item) => {
        const productEl = $(item)
        const detailId = productEl.attr('data-detail-id')
        // Kiểm tra xem detailId đã tồn tại trong mảng chưa
        if (!productSelectedListDetailId.includes(detailId)) {
          // Nếu chưa tồn tại, thêm vào mảng
          productSelectedListDetailId.push(detailId);
        }

      })

      productListCurrent.forEach(product => {
        product.productDetailDtos.forEach(detail => {
          appendSelectProduct({
            name: product.name,
            imageUrl: product.imageUrl,
            detail: detail
          })
        })
      })
      paginateSelectedProductList()
    })
    $('#remove-all-select').on('click', function () {
      $('.list-select-product').html('')
      $('.product-item').prop('disabled', false)
      productSelectedList = []
      productSelectedListDetailId = []
      setInitChoosedFalse()
      loadHtmlProduct(productListInit)
      paginateProductList()
    })
  })
</script>
</body>
</html>